@startuml 04_roadside_geology_langgraph
!include _common.puml
title Roadside Geology v0 â€” Agentic Workflow (LangGraph)

start

partition "Route prep" {
  :ingest_route\n(GPX / JSON points);
  :compute cumulative distance;
  :sample_points\n(sample_every_m);
}

partition "Discovery (tools)" {
  :geosearch\n(Wikipedia GeoSearch);
  :fetch_page\n(extract + url + metadata);
  :filter candidates (geology relevance);
  :select stops\n(dedupe + spacing + max_stops);
}

partition "Index" {
  :chunk selected pages;
  :embed chunks;
  :build / update vector index;
}

partition "Per-stop loop" {
  repeat
    :retrieve\n(vector store similarity);
    :write_stop_card\n(LLM + JSON schema);
    :validate_stop_card\n(schema + wikipedia-only citations);
    if (valid?) then (yes)
    else (no)
      :retry once\n(stricter rules);
      :validate_stop_card;
    endif
  repeat while (next stop?) is (yes)
}

partition "Outputs" {
  :render_outputs\n(guide.json + guide.md);
}

stop

@enduml


@startuml 06_anc_databricks_production_app
!include _common.puml
title ANC â€” Future Production Databricks Full App

skinparam activity {
  BackgroundColor #F8FAFC
  BorderColor #334155
  FontColor #0F172A
}

|#E0F2FE Request Path|
start
:#E0F2FE Mobile/Web user asks question,\npasses route context, and optionally adds photo;
:[API] receive request;
:[Orchestrator] build retrieval/generation plan;
:[Cache] lookup for hot prompts/routes;
:[Vector Search] retrieve top-k\n(Unity Catalog governed);
:[LLM/Vision endpoints] grounded generation;
:[Policy gate] citation + safety + uncertainty checks;
:#DCFCE7 [API] return stop cards + citations + confidence;

fork
  |#ECFDF5 Data Refresh|
  :#ECFDF5 [Pipelines] ingest from Wikipedia + USGS + Maps;
  :#ECFDF5 [Lakebase / UC MLflow tables] write curated tables;
  :#ECFDF5 [Embedding job] batch upsert from chunk deltas;
  :#ECFDF5 [Vector Search] refresh indexes;
fork again
  |#FEF9C3 Observability|
  :#FEF9C3 [MLflow] tracing + eval artifacts;
  :#FEF9C3 [Monitoring] quality/latency/drift dashboards;
  :#FEF9C3 [Jobs] refresh signals from monitoring;
end fork

|#FFF7ED Cost Controls|
:#FFF7ED [Free Edition controls]\nbatch refresh windows + strict top-k budgets +\nsmaller default model tier + aggressive cache;
stop

note right
Real-data path replaces fallback retrieval adapters,\nwhile preserving output schema and quality gates.
end note

legend bottom
Blue lane: request/response path.
Green lane: scheduled ingest + indexing.
Yellow lane: monitoring and eval loop.
Orange lane: cost guardrails for free-tier operation.
endlegend

@enduml
